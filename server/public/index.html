<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    login page<br>
    <div id="loginPage">
        <input id="acc"></input>
        <input id="pwd" type="password"></input>
        <button id="loginBtn">login</button>
        <div id="status"></div>
        <div id="status"></div>
    </div>
    <div id="questionPage">

    </div>
    <script>

        const acc = document.querySelector("#acc");
        const pwd = document.querySelector("#pwd");
        const loginBtn = document.querySelector("#loginBtn");
        const login_status = document.querySelector("#status");
        const questionPage = document.querySelector("#questionPage");

        const api = new URL(location.href);
        const apiUrls = JSON.parse(api.searchParams.get('apiUrls'));
        const uuid = api.searchParams.get('uuid');
        console.log(apiUrls, uuid)

        const QusetionTemplate = `
        <h1>&title</h1>
        <p>&description</p>
        <div>
            &buttons
            <iframe id="myframe" height="200" width="300" title="Iframe Example" allow-scripts="true"></iframe>
        </div>`
        const buttonTemplate = '<input type="button" value="需求&buttonId." onclick="onFocus(&buttonId, `&qusetion`);" class="btn">'
        loginBtn.onclick = () => {
            if (pwd.value == "" || acc.value == "") return;
            fetch(apiUrls["login"], {
                body: JSON.stringify({
                    uuid: uuid,
                    account: acc.value,
                    password: pwd.value
                }),
                headers: {
                    'user-agent': 'Mozilla/4.0 MDN Example',
                    'content-type': 'application/json',
                    "Access-Control-Allow-Origin": "*"
                },
                method: 'POST'
            }).then((res) => {
                return res.json();
            }).then(async (data) => {
                console.log(data)
                login_status.innerHTML = `status: ${JSON.stringify(data)}`;

                if (data.statusCode == 1) {
                    // 登陸成功
                    // 選題目
                    let url = new URL(apiUrls["data"]);
                    url.search = new URLSearchParams({
                        dataName: "read_question",
                        arguments: JSON.stringify({
                            chapterId: '1',
                            questionId: '1'
                        })
                    });

                    let respond = await fetch(url.href, {
                        headers: {
                            'user-agent': 'Mozilla/4.0 MDN Example',
                            'content-type': 'application/json',
                            "Access-Control-Allow-Origin": "*"
                        },
                        method: 'get'
                    }).then((res) => {
                        return res.json();
                    }).catch(err => {
                        console.error(err);
                    });

                    console.log(respond);

                    let question = {
                        question_title: "question_title",
                        question_description: "question_description",
                        question_demands: [
                            "實體型態包含：醫師（Doctor）、住院病人（InPatient）、檢驗項目（TestItem）、病房（Room）。 ",
                            "醫師有三個屬性：代號（dId）、姓名（dName）、性別 （gender）。其中代號是唯一的。 ",
                            "住院病人有三個屬性：病人代號（pId）、姓名（pName）、緊急聯 絡人（contact），其中緊急聯絡人可以有多位，且必須記載緊急聯絡人之姓名（name）與電話（phone）。此外病人代號是唯一的。",
                            "檢驗項目有兩個屬性：項目代號（tId）、名稱（tName）。其中項 目代號是唯一的。",
                            "病房有兩個屬性：房號（rNo）、等級（level）。其中房號是唯一的。",
                            "每一位住院病人必定有一位主治醫師；每個醫生可以看很多住院病人，至少需要看一個住院病人。",
                            "每一位住院病人可以有多個檢驗項目，檢驗日期 （date）必須記載；每個住院病人至少要有一個檢驗項目。",
                            "每一個病房可以最多住六個住院病人，也可能是空病房；每個住院病人只能住在一間病房。",
                            "每一個醫生可以檢視多個檢驗項目；每個檢驗項目可以被多個醫生檢驗。"
                        ]

                    } //respond.data;


                    let buttons = "";
                    for (let d in question.question_demands) {
                        console.log(question.question_demands[d], buttons)
                        buttons += buttonTemplate.replace("&buttonId", d).replace("&buttonId", d).replace("&qusetion", question.question_demands[d])
                    }

                    questionPage.innerHTML = QusetionTemplate
                        .replace("&title", question.question_title)
                        .replace("&description", question.question_description)
                        .replace("&buttons", buttons);

                }
            }).catch(err => {
                console.log(err);
            })
            acc.value = "";
            pwd.value = "";
        }

        var timer = null;
        const time = 5000;
        function onFocus(number, qusetion) {
            //window.clearTimeout(x)
            const iframeWindow = document.getElementsByTagName('iframe')[0].contentWindow;
            iframeWindow.document.body.innerHTML = qusetion;
            startTimer()
        }

        var startTimer = function () {
            window.clearTimeout(timer);
            timer = window.setTimeout("turndown()", time);
        }

        function turndown() {
            const iframeWindow = document.getElementsByTagName('iframe')[0].contentWindow;
            console.log(iframeWindow)
            iframeWindow.document.body.innerHTML = ''
        }



    </script>
</body>

</html>